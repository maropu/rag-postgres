<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>31.7. アーキテクチャ</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="prev" href="logical-replication-restrictions.html" title="31.6. 制限事項" /><link rel="next" href="logical-replication-monitoring.html" title="31.8. 監視" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /><style type="text/css"><!--
h1.TITLE {clear:both;}
.versions {
  float:right;
  margin-top:-0.2em;
  margin-bottom:0.5em;
  width: auto;
  padding:0.4em 1em;
  border:solid 1px #e0e0e0;
  border-radius:0.5em;
  background:#f3f3f3;
  background-image:-webkit-linear-gradient(#fbfbfb, #ebebeb);
  background-image:-moz-linear-gradient(#fbfbfb, #ebebeb);
  background-image:-o-linear-gradient(#fbfbfb, #ebebeb);
  background-image:linear-gradient(#fbfbfb, #ebebeb);
  box-shadow:0 3px 8px -3px #000;
}
.versions .label {
  cursor:pointer;
}
.versions .label:hover {
  text-decoration:underline;
}
.versions .list {
  display:none;
}
.versions .list-toggle {
  display:inline;
}
.versions .me {
  padding:0 0.2em;
  border:solid 2px #e88;
  border-radius:0.3em;
  background:#fbfbfb;
  font-weight:bold;
}
.versions .other {
  font-weight:bold;
}
.versions .unsup {
  color:#aaa;
}
.versions .unsup a {
  color:#aaa;
}

@media print {
  a {
    color: inherit;
    text-decoration: none;
  }
  a:visited {
    color: inherit;
  }
  .NAVHEADER, .versions, .NAVFOOTER {
    display: none;
  }
}
--></style><script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript"><!--
  $(function(){
      $(".versions .label").bind("click", function(){
          $(".versions .list").toggleClass("list-toggle");
      })
  });
--></script></head><body id="docContent" class="container-fluid col-10"><div class="versions"><span class="label">他のバージョンの文書</span> <span class="list">： <span class="me">15</span> | <span class="other"><a href="/document/14/html/logical-replication-architecture.html">14</a><span> | <span class="other"><a href="/document/13/html/logical-replication-architecture.html">13</a><span> | <span class="other"><a href="/document/12/html/logical-replication-architecture.html">12</a><span> | <span class="other"><a href="/document/11/html/logical-replication-architecture.html">11</a><span> | <span class="other"><a href="/document/10/html/logical-replication-architecture.html">10</a><span> | <span class="unsup"><a href="/document/9.6/index.html">9.6</a></span> | <span class="unsup"><a href="/document/9.5/index.html">9.5</a></span> | <span class="unsup"><a href="/document/9.4/index.html">9.4</a></span> | <span class="unsup"><a href="/document/9.3/index.html">9.3</a></span> | <span class="unsup"><a href="/document/9.2/index.html">9.2</a></span> | <span class="unsup"><a href="/document/9.1/index.html">9.1</a></span> | <span class="unsup"><a href="/document/9.0/index.html">9.0</a></span> | <span class="unsup"><a href="/document/8.4/index.html">8.4</a></span> | <span class="unsup"><a href="/document/8.3/index.html">8.3</a></span> | <span class="unsup"><a href="/document/8.2/index.html">8.2</a></span> | <span class="unsup"><a href="/document/8.1/index.html">8.1</a></span> | <span class="unsup"><a href="/document/8.0/index.html">8.0</a></span> | <span class="unsup"><a href="/document/7.4/index.html">7.4</a></span> | <span class="unsup"><a href="/document/7.3/index.html">7.3</a></span> | <span class="unsup"><a href="/document/7.2/index.html">7.2</a></span></span></div><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="4" align="center"><a accesskey="h" href="index.html">PostgreSQL 15.4文書</a></th></tr><tr><td width="10%" align="left"></td><td width="10%" align="left"></td><td width="60%" align="center"><a href="logical-replication.html" title="第31章 論理レプリケーション">第31章 論理レプリケーション</a></td><td width="20%" align="right"></td></tr><tr><td width="10%" align="left"><a accesskey="p" href="logical-replication-restrictions.html" title="31.6. 制限事項">前へ</a> </td><td width="10%" align="left"><a accesskey="u" href="logical-replication.html" title="第31章 論理レプリケーション">上へ</a></td><td width="60%" align="center">31.7. アーキテクチャ</td><td width="20%" align="right"> <a accesskey="n" href="logical-replication-monitoring.html" title="31.8. 監視">次へ</a></td></tr></table><hr /></div><div class="sect1" id="LOGICAL-REPLICATION-ARCHITECTURE"><div class="titlepage"><div><div><h2 class="title" style="clear: both">31.7. アーキテクチャ</h2></div></div></div><!--
  <title>Architecture</title>
--><p>
<!--
   Logical replication starts by copying a snapshot of the data on the
   publisher database.  Once that is done, changes on the publisher are sent
   to the subscriber as they occur in real time.  The subscriber applies data
   in the order in which commits were made on the publisher so that
   transactional consistency is guaranteed for the publications within any
   single subscription.
-->
論理レプリケーションは、パブリッシャー側のデータベース上のデータのスナップショットをコピーすることから始まります。
それが完了したあとは、パブリッシャーにおける変更は、発生した時にリアルタイムでサブスクライバーに送られます。
サブスクライバーはパブリッシャーでコミットが発生した順にデータを適用します。
そのため、どの単一のサブスクリプションにおいても、パブリケーションに対するトランザクションの一貫性が保証されます。
  </p><p>
<!--
   Logical replication is built with an architecture similar to physical
   streaming replication (see <xref linkend="streaming-replication"/>).  It is
   implemented by <quote>walsender</quote> and <quote>apply</quote>
   processes.  The walsender process starts logical decoding (described
   in <xref linkend="logicaldecoding"/>) of the WAL and loads the standard
   logical decoding plugin (pgoutput).  The plugin transforms the changes read
   from WAL to the logical replication protocol
   (see <xref linkend="protocol-logical-replication"/>) and filters the data
   according to the publication specification.  The data is then continuously
   transferred using the streaming replication protocol to the apply worker,
   which maps the data to local tables and applies the individual changes as
   they are received, in correct transactional order.
-->
論理レプリケーションは物理ストリーミングレプリケーション(<a class="xref" href="warm-standby.html#STREAMING-REPLICATION" title="27.2.5. ストリーミングレプリケーション">27.2.5</a>参照)と似たアーキテクチャで構成されています。
<span class="quote">「<span class="quote">WAL送信</span>」</span>プロセスと<span class="quote">「<span class="quote">適用</span>」</span>プロセスで実装されています。
WAL送信プロセスはWALのロジカルデコーディング（<a class="xref" href="logicaldecoding.html" title="第49章 ロジカルデコーディング">第49章</a>に記載）を開始し、標準のロジカルデコーディングプラグイン（pgoutput）をロードします。
このプラグインは、WALから読み込んだ更新を論理レプリケーションプロトコル（<a class="xref" href="protocol-logical-replication.html" title="55.5. 論理ストリーミングレプリケーションのプロトコル">55.5</a>参照）に変換します。
そして、パブリケーションの指定にしたがってフィルタします。
データは次に、ストリーミングレプリケーションプロトコルを使って継続的に適用ワーカーに転送されます。
適用ワーカーは、データをローカルテーブルにマップし、更新を受信すると正しいトランザクション順に個々の更新を適用します。
  </p><p>
<!--
   The apply process on the subscriber database always runs with
   <link linkend="guc-session-replication-role"><varname>session_replication_role</varname></link>
   set to <literal>replica</literal>. This means that, by default,
   triggers and rules will not fire on a subscriber. Users can optionally choose to
   enable triggers and rules on a table using the
   <link linkend="sql-altertable"><command>ALTER TABLE</command></link> command
   and the <literal>ENABLE TRIGGER</literal> and <literal>ENABLE RULE</literal>
   clauses.
-->
サブスクライバーデータベース上の適用プロセスは、常に<a class="link" href="runtime-config-client.html#GUC-SESSION-REPLICATION-ROLE"><code class="varname">session_replication_role</code></a>を<code class="literal">replica</code>に設定して実行されます。
これは、デフォルトでは、トリガーとルールはサブスクライバー上では起動されないことを意味します。
ユーザーは、必要に応じて、 <a class="link" href="sql-altertable.html" title="ALTER TABLE"><code class="command">ALTER TABLE</code></a>コマンド、<code class="literal">ENABLE TRIGGER</code>および<code class="literal">ENABLE RULE</code>句を使用して、テーブルのトリガーおよびルールを有効にすることを選択できます。
  </p><p>
<!--
   The logical replication apply process currently only fires row triggers,
   not statement triggers.  The initial table synchronization, however, is
   implemented like a <command>COPY</command> command and thus fires both row
   and statement triggers for <command>INSERT</command>.
-->
今のところ、論理レプリケーション適用プロセスは行トリガーだけを起動し、文トリガーは起動しません。
ただし、初期テーブル同期は<code class="command">COPY</code>コマンドのように実装されているので、<code class="command">INSERT</code>の行と文トリガーの両方を起動します。
  </p><div class="sect2" id="LOGICAL-REPLICATION-SNAPSHOT"><div class="titlepage"><div><div><h3 class="title">31.7.1. 初期スナップショット</h3></div></div></div><!--
    <title>Initial Snapshot</title>
--><p>
<!--
     The initial data in existing subscribed tables are snapshotted and
     copied in a parallel instance of a special kind of apply process.
     This process will create its own replication slot and copy the existing
     data.  As soon as the copy is finished the table contents will become
     visible to other backends.  Once existing data is copied, the worker
     enters synchronization mode, which ensures that the table is brought
     up to a synchronized state with the main apply process by streaming
     any changes that happened during the initial data copy using standard
     logical replication.  During this synchronization phase, the changes
     are applied and committed in the same order as they happened on the
     publisher.  Once synchronization is done, control of the
     replication of the table is given back to the main apply process where
     replication continues as normal.
-->
既存のサブスクライブされたテーブル中の初期データのスナップショットが取得され、特殊な適用プロセスの並列インスタンスにコピーされます。
このプロセスは自身のレプリケーションスロットを作成し、既存のデータをコピーします。
コピーが終わるとすぐにテーブル内容が他のバックエンドから見えるようになります。
既存のデータのコピーが終わると、ワーカーは同期モードに入ります。
このモードでは、初期データのコピー中に起こった更新を標準の論理レプリケーションを使ってストリーミングすることにより、テーブルが主適用プロセスと同期状態になることを保証します。
この同期フェーズの間、パブリッシャーで発生したのと同じ順序で変更が適用され、コミットされます。
ひとたび同期が完了すれば、テーブルのレプリケーションの制御は主適用プロセスに戻され、レプリケーションは通常通り継続されます。
    </p><div class="note"><h3 class="title">注記</h3><p>
<!--
      The publication <literal>publish</literal> parameter only affects what
      DML operations will be replicated. The initial data synchronization does
      not take this parameter into account when copying the existing table data.
-->
パブリケーションの<code class="literal">パブリッシュ</code>パラメータは、レプリケーションされるDML操作にのみ影響します。
初期データ同期では、既存のテーブルデータをコピーするときにこのパラメータは考慮されません。
     </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="logical-replication-restrictions.html" title="31.6. 制限事項">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="logical-replication.html" title="第31章 論理レプリケーション">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="logical-replication-monitoring.html" title="31.8. 監視">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">31.6. 制限事項 </td><td width="20%" align="center"><a accesskey="h" href="index.html" title="PostgreSQL 15.4文書">ホーム</a></td><td width="40%" align="right" valign="top"> 31.8. 監視</td></tr></table></div></body></html>